name: Deploy PaiNamNae Full System

on:
  push:
    branches: [ "main" ]

jobs:
  # =================================================================
  # JOB 1: Deploy Backend & Database (บน VM - Self-hosted)
  # =================================================================
  deploy-vm:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update VM Docker Containers
        run: |
          # 1. ดึงไฟล์ .env ความลับจากเครื่อง Server มาใช้
          # (เปลี่ยน ~/Project... เป็น Path เต็มถ้าจำเป็น เช่น /home/project/...)
          cp ~/Project_painamnae/PaiNamNaeWebApp/.env .

          # 2. [ท่าไม้ตาย] ลบ Container เก่าที่อาจจะค้างอยู่แบบถอนรากถอนโคน
          # ใส่ || true เพื่อบอกว่า "ถ้าหาไม่เจอก็ข้ามไป อย่าแจ้ง Error"
          # (ไม่ต้องห่วง Database เพราะข้อมูลอยู่ใน Volume ไม่ได้ถูกลบไปด้วย)
          docker rm -f painamnae-tunnel painamnae-db painamnae-backend painamnae-frontend || true

          # 3. สั่ง Down ระบบ Compose เพื่อเคลียร์ Network ที่ค้าง
          docker compose down --remove-orphans

          # 4. สร้างระบบใหม่ทั้งหมด (Build ใหม่ทุกครั้งเพื่อความสดใหม่)
          docker compose --profile prod up -d --build

          # 5. ลบ Image ขยะที่ไม่ได้ใช้แล้ว เพื่อประหยัดพื้นที่ VM
          docker image prune -f

  # =================================================================
  # JOB 2: Deploy Frontend (ไป HestiaCP - Ubuntu Latest)
  # =================================================================
  deploy-hestia:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Dependencies
        run: |
          cd frontend
          # ลบของเก่าเพื่อให้มั่นใจว่าลงใหม่หมดจด
          rm -rf package-lock.json node_modules
          npm install

      - name: Build Static Site & Generate .htaccess
        env:
          # ฝัง URL Backend เข้าไปใน Frontend ตอน Build เลย
          NUXT_PUBLIC_API_BASE: "https://api.kit09k.online/api/"
        run: |
          cd frontend
          npm run generate
          
          # สร้างไฟล์ .htaccess เพื่อแก้ปัญหา Refresh หน้าเว็บแล้วพัง (404) บน Apache
          echo "RewriteEngine On" > .output/public/.htaccess
          echo "RewriteBase /" >> .output/public/.htaccess
          echo "RewriteRule ^index\.html$ - [L]" >> .output/public/.htaccess
          echo "RewriteCond %{REQUEST_FILENAME} !-f" >> .output/public/.htaccess
          echo "RewriteCond %{REQUEST_FILENAME} !-d" >> .output/public/.htaccess
          echo "RewriteRule . /index.html [L]" >> .output/public/.htaccess

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          # โฟลเดอร์ที่ Nuxt 3 build ออกมา
          local-dir: ./frontend/.output/public/
          # โฟลเดอร์ปลายทางบน Server HestiaCP
          server-dir: /home/csse0168/web/painamnae2-3.cpkku.com/public_html/
          # ลบไฟล์เก่าทิ้งทั้งหมดก่อนอัปโหลด (Clean Slate)
          dangerous-clean-slate: true

# name: Deploy PaiNamNae Full System

# on:
#   push:
#     branches: [ "main" ]

# jobs:
#   # -----------------------------------------------------------------
#   # JOB 1: VM (แก้เรื่อง Git 128)
#   # -----------------------------------------------------------------
#   deploy-vm:
#     runs-on: self-hosted
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Update VM Docker Containers
#         run: |
#           # ดึง .env เดิมมาใช้
#           cp ~/Project_painamnae/PaiNamNaeWebApp/.env .
#           docker rm -f painamnae-tunnel || true
#           docker compose down --remove-orphans
#           docker compose --profile prod up -d --build
#           docker image prune -f

#   # -----------------------------------------------------------------
#   # JOB 2: Hestia (แก้เรื่อง Path FTP)
#   # -----------------------------------------------------------------
#   deploy-hestia:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '18'

#       - name: Install Dependencies
#         run: |
#           cd frontend
#           rm -rf package-lock.json node_modules
#           npm install

#       - name: Build Static Site
#         env:
#           NUXT_PUBLIC_API_BASE: "https://api.kit09k.online/api/"
#         run: |
#           cd frontend
#           npm run generate
#           # สร้าง .htaccess
#           echo "RewriteEngine On" > .output/public/.htaccess
#           echo "RewriteBase /" >> .output/public/.htaccess
#           echo "RewriteRule ^index\.html$ - [L]" >> .output/public/.htaccess
#           echo "RewriteCond %{REQUEST_FILENAME} !-f" >> .output/public/.htaccess
#           echo "RewriteCond %{REQUEST_FILENAME} !-d" >> .output/public/.htaccess
#           echo "RewriteRule . /index.html [L]" >> .output/public/.htaccess

#       - name: Deploy via FTP
#         uses: SamKirkland/FTP-Deploy-Action@v4.3.5
#         with:
#           server: ${{ secrets.FTP_SERVER }}
#           username: ${{ secrets.FTP_USERNAME }}
#           password: ${{ secrets.FTP_PASSWORD }}
#           local-dir: ./frontend/.output/public/
#           server-dir: /home/csse0168/web/painamnae2-3.cpkku.com/public_html/
#           dangerous-clean-slate: true
